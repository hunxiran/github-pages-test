(window.webpackJsonp=window.webpackJsonp||[]).push([[51],{150:function(e,t,n){"use strict";n.r(t),n.d(t,"frontMatter",(function(){return s})),n.d(t,"metadata",(function(){return c})),n.d(t,"rightToc",(function(){return l})),n.d(t,"default",(function(){return p}));var a=n(1),r=n(6),o=(n(0),n(156)),i=n(158),s={id:"lesson3",title:"Reactivity in Vuejs",sidebar_label:"Lesson3"},c={id:"advanceComp/lesson3",title:"Reactivity in Vuejs",description:"import useBaseUrl from '@docusaurus/useBaseUrl';\r",source:"@site/docs\\advanceComp\\lesson3.md",permalink:"/github-pages-test/docs/advanceComp/lesson3",editUrl:"https://github.com/facebook/docusaurus/edit/master/website/docs/advanceComp/lesson3.md",sidebar_label:"Lesson3",sidebar:"someSidebar",previous:{title:"Evan You on Proxies",permalink:"/github-pages-test/docs/advanceComp/lesson2"},next:{title:"Evan You on Vue Core",permalink:"/github-pages-test/docs/advanceComp/lesson4"}},l=[{value:"Question: Where is Reactivity?",id:"question-where-is-reactivity",children:[]},{value:"Answer: Tracing the Code Execution",id:"answer-tracing-the-code-execution",children:[]},{value:"Question: But what\u2019s inside that Dep class?",id:"question-but-whats-inside-that-dep-class",children:[]},{value:"Problem: Caveats to the Reactivity System",id:"problem-caveats-to-the-reactivity-system",children:[]},{value:"Stay Tuned",id:"stay-tuned",children:[]}],u={rightToc:l};function p(e){var t=e.components,n=Object(r.a)(e,["components"]);return Object(o.b)("wrapper",Object(a.a)({},u,n,{components:t,mdxType:"MDXLayout"}),Object(o.b)("p",null,"Using the knowledge we learned ",Object(o.b)("a",Object(a.a)({parentName:"p"},{href:"https://www.vuemastery.com/courses/advanced-components/build-a-reactivity-system/"}),"building a reactivity system")," in our first lesson, we\u2019ll dive into the Vue.js source code to find where the reactivity lives. Doing so will help us:"),Object(o.b)("ul",null,Object(o.b)("li",{parentName:"ul"},"Get comfortable parsing though the Vue.js source"),Object(o.b)("li",{parentName:"ul"},"Learn Vue.js design patterns & architecture"),Object(o.b)("li",{parentName:"ul"},"Improve your debugging skills"),Object(o.b)("li",{parentName:"ul"},"Learn caveats to the reactivity system")),Object(o.b)("p",null,"It all will start with a simple Vue application."),Object(o.b)("pre",null,Object(o.b)("code",Object(a.a)({parentName:"pre"},{className:"language-html"}),'<div id="app">\n  <h1>{{ product }}</h1>\n</div>\n')),Object(o.b)("pre",null,Object(o.b)("code",Object(a.a)({parentName:"pre"},{className:"language-js"}),'<script src="vue.js"><\/script>\n\n<script>\nvar app = new Vue({\n  el: \'#app\',\n  data: {\n    product: "Socks"\n  }\n})\n<\/script>\n')),Object(o.b)("h2",{id:"question-where-is-reactivity"},"Question: Where is Reactivity?"),Object(o.b)("p",null,"At some point the ",Object(o.b)("inlineCode",{parentName:"p"},"product")," property inside the ",Object(o.b)("inlineCode",{parentName:"p"},"data")," object gets reactive super powers. It\u2019d be nice to know where and how this happens."),Object(o.b)("p",null,"If we look in ",Object(o.b)("a",Object(a.a)({parentName:"p"},{href:"https://vuejs.org/v2/api/#Options-Data"}),"the documentation")," for this data object we find:"),Object(o.b)("img",{alt:"documentation",src:Object(i.a)("/img/Reactivity1.png")}),Object(o.b)("p",null,"See how it talks about getters/setters to make it reactive? It also mentions that the object must be plain, just data. So somewhere in the source it\u2019s making the properties in data reactive, and adding the ability to remember what needs to get updated when the property values changes. Remember, when data is GET we ",Object(o.b)("strong",{parentName:"p"},"add")," a dependency, and when it\u2019s SET we ",Object(o.b)("strong",{parentName:"p"},"notify")," all the dependencies."),Object(o.b)("h2",{id:"answer-tracing-the-code-execution"},"Answer: Tracing the Code Execution"),Object(o.b)("p",null,"I started by downloading the ",Object(o.b)("a",Object(a.a)({parentName:"p"},{href:"https://github.com/vuejs/vue"}),"Vue.js source code")," so I could generate a local version of Vue. I wrote up an ",Object(o.b)("inlineCode",{parentName:"p"},"index.html")," file with the contents that you see above, and used the Chrome DevTools Debugger to watch the code execute one line at a time. It\u2019s easier than you might think."),Object(o.b)("p",null,"When our Vue application starts up, we\u2019ll begin here:"),Object(o.b)("p",null,"/src/core/instance/index.js"),Object(o.b)("pre",null,Object(o.b)("code",Object(a.a)({parentName:"pre"},{className:"language-js"}),"import { initMixin } from './init'\nimport { stateMixin } from './state'\nimport { renderMixin } from './render'\nimport { eventsMixin } from './events'\nimport { lifecycleMixin } from './lifecycle'\nimport { warn } from '../util/index'\n\nfunction Vue (options) {\n  ... // ommitted code\n  this._init(options)\n}\ninitMixin(Vue)  // goes here next\nstateMixin(Vue)\neventsMixin(Vue)\nlifecycleMixin(Vue)\nrenderMixin(Vue)\nexport default Vue\n")),Object(o.b)("p",null,"There\u2019s our root Vue function that creates our instance when we call ",Object(o.b)("inlineCode",{parentName:"p"},"var app = new Vue({ .. })"),". Notice it calls ","_","init, which is a prototype function that gets added to our Vue object."),Object(o.b)("p",null,Object(o.b)("strong",{parentName:"p"},"Side Note:")," In the code above and the code that follows I\u2019ve omitted code to simplify what you have to read."),Object(o.b)("p",null,"/src/core/instance/init.js"),Object(o.b)("pre",null,Object(o.b)("code",Object(a.a)({parentName:"pre"},{className:"language-js"}),"export function initMixin (Vue: Class<Component>) {\n  Vue.prototype._init = function (options?: Object) {\n    const vm: Component = this\n\n    ... Normalizing options ...\n    vm._self = vm\n    initLifecycle(vm)\n    initEvents(vm)\n    initRender(vm) // defineReactive attrs and listeners\n    callHook(vm, 'beforeCreate') // Notice this lifecycle call hook\n    initInjections(vm) // resolve injections before data/props\n    initState(vm)  // <---\n    initProvide(vm) // resolve provide after data/props\n    callHook(vm, 'created') // Notice this lifecycle call hook\n    ...\n    vm.$mount(vm.$options.el)\n  }\n}\n")),Object(o.b)("p",null,"Inside init we do many things, but we\u2019re interested in InitState."),Object(o.b)("p",null,"/src/core/instance/state.js"),Object(o.b)("pre",null,Object(o.b)("code",Object(a.a)({parentName:"pre"},{className:"language-js"}),"export function initState (vm: Component) {\n  vm._watchers = []\n  const opts = vm.$options\n  if (opts.props) initProps(vm, opts.props)\n  if (opts.methods) initMethods(vm, opts.methods)\n  if (opts.data) {\n    initData(vm)  // <---  We do have data\n  } else {\n    observe(vm._data = {}, true /* asRootData */)\n  }\n  if (opts.computed) initComputed(vm, opts.computed)\n  if (opts.watch && opts.watch !== nativeWatch) {\n    initWatch(vm, opts.watch)\n  }\n}\n...\n")),Object(o.b)("p",null,"As you can see, we initialize Props, Methods, and then initData, which continues in the same file below."),Object(o.b)("pre",null,Object(o.b)("code",Object(a.a)({parentName:"pre"},{className:"language-js"}),'...\nfunction initData (vm: Component) {\n  let data = vm.$options.data // The value here is { product: "Socks" }\n  ...\n\n  observe(data, true /* asRootData */)  // <--- Here we go\n}\n')),Object(o.b)("p",null,"See how we call \u201cobserve\u201d on our data? We\u2019re getting closer."),Object(o.b)("p",null,"/src/core/observer/index.js"),Object(o.b)("pre",null,Object(o.b)("code",Object(a.a)({parentName:"pre"},{className:"language-js"}),'export function observe (value: any, asRootData: ?boolean): Observer | void {\n  ... // Our value is still { product: "Socks" }\n  ob = new Observer(value)\n  return ob\n}\n')),Object(o.b)("p",null,"Okay, so our observer does something with our data. Let\u2019s dive deeper."),Object(o.b)("p",null,"/src/core/observer/index.js"),Object(o.b)("pre",null,Object(o.b)("code",Object(a.a)({parentName:"pre"},{className:"language-js"}),"export class Observer {\n  value: any;\n\n  constructor (value: any) {\n    this.value = value  // { product: \"Socks\" }\n    ...\n    if (Array.isArray(value)) {  // We don't have an array but if we did\n      ...\n      this.observeArray(value) // We would call observeArray (shown below)\n    } else {\n      this.walk(value)  // Walk through each property\n    }\n  }\n  /**\n    * Walk through each property and convert them into\n    * getter/setters. This method should only be called when\n    * value type is Object.\n    */\n  walk (obj: Object) {\n    const keys = Object.keys(obj)  // keys = [\"product\"]\n    for (let i = 0; i < keys.length; i++) {  // Go through each key\n      defineReactive(obj, keys[i], obj[keys[i]])  // <--- Going here next\n                  // Calling defineReactive(obj, 'product', 'Socks')\n    }\n  }\n  /**\n    * Observe a list of Array items.\n    */\n  observeArray (items: Array<any>) {\n    for (let i = 0, l = items.length; i < l; i++) {\n      observe(items[i])  // Just call observe on each item\n    }\n  }\n}\n")),Object(o.b)("p",null,"See how if our data is an array we call ",Object(o.b)("inlineCode",{parentName:"p"},"observe")," on each of the items? If it\u2019s not an array we go to the ",Object(o.b)("inlineCode",{parentName:"p"},"walk")," function, get all our keys, and then we call ",Object(o.b)("inlineCode",{parentName:"p"},"defineReactive"),"?"),Object(o.b)("p",null,"That\u2019s where we go next."),Object(o.b)("p",null,"/src/core/observer/index.js"),Object(o.b)("pre",null,Object(o.b)("code",Object(a.a)({parentName:"pre"},{className:"language-js"}),"/**\n  * Define a reactive property on an Object.\n  */\nexport function defineReactive (\n  obj: Object,\n  key: string,  // <--- \"product\"\n  val: any, // <--- \"Socks\" this will be our internalValue\n  customSetter?: ?Function,\n  shallow?: boolean\n) {\n  const dep = new Dep() // <--- There's our dependency class like from the last lesson.\n  const property = Object.getOwnPropertyDescriptor(obj, key)\n  if (property && property.configurable === false) {\n    return // if property is not set as configurable, then return\n  }\n  // cater for pre-defined getter/setters\n  const getter = property && property.get\n  const setter = property && property.set\n\n  Object.defineProperty(obj, key, {  // <--- There's our defineProperty\n    enumerable: true,\n    configurable: true,\n    get: function reactiveGetter () { // <--- There's our Get\n      const value = getter ? getter.call(obj) : val // <--- If we have a defined getter, then use that; otherwise return value, like we did with our internalVal.\n\n      if (Dep.target) {\n        dep.depend() // <-- There's our depend function\n        ...\n      }\n      return value // A Getter returns a value.\n    },\n    set: function reactiveSetter (newVal) {\n      const value = getter ? getter.call(obj) : val // <-- if custom getter\n\n      // If the value is the same don't do anything.\n      if (newVal === value || (newVal !== newVal && value !== value)) {\n        return\n      }\n\n      if (setter) {\n        setter.call(obj, newVal)\n      } else {\n        val = newVal // <--- Set the new value.\n      }\n      dep.notify() // <-- There's our notify\n    }\n  })\n}\n")),Object(o.b)("p",null,"Aha, there\u2019s our reactivity! Pretty similar to what we wrote, isn\u2019t it? If we trace from the top down, here\u2019s what our path down to Reactivity looks like!"),Object(o.b)("img",{alt:"reactivity2",src:Object(i.a)("/img/Reactivity2.png")}),Object(o.b)("h2",{id:"question-but-whats-inside-that-dep-class"},"Question: But what\u2019s inside that Dep class?"),Object(o.b)("p",null,"I know I was really curious at this point to see what was inside my Dep class, but before we get there we need to understand more about Vue\u2019s ",Object(o.b)("inlineCode",{parentName:"p"},"Watcher class")," . Remember our Watch Function from the last lesson?"),Object(o.b)("img",{alt:"reactivity3",src:Object(i.a)("/img/Reactivity3.png")}),Object(o.b)("p",null,"Well, Vue has a Watcher class which:"),Object(o.b)("ul",null,Object(o.b)("li",{parentName:"ul"},Object(o.b)("p",{parentName:"li"},"Receives as a parameter the code to watch (like above)")),Object(o.b)("li",{parentName:"ul"},Object(o.b)("p",{parentName:"li"},"Stores the code inside a ",Object(o.b)("inlineCode",{parentName:"p"},"getter")," property")),Object(o.b)("li",{parentName:"ul"},Object(o.b)("p",{parentName:"li"},"Has a ",Object(o.b)("inlineCode",{parentName:"p"},"get")," function (called directly in instantiation, or by the scheduler) which:\n-Runs ",Object(o.b)("inlineCode",{parentName:"p"},"pushTarget(this)")," to set ",Object(o.b)("inlineCode",{parentName:"p"},"Dep.target")," to this watcher object\n-Calls ",Object(o.b)("inlineCode",{parentName:"p"},"this.getter.call")," to run this code\n-Runs ",Object(o.b)("inlineCode",{parentName:"p"},"popTarget()")," to remove current ",Object(o.b)("inlineCode",{parentName:"p"},"Dep.target"))),Object(o.b)("li",{parentName:"ul"},Object(o.b)("p",{parentName:"li"},"Has an ",Object(o.b)("inlineCode",{parentName:"p"},"update")," function to queue this ",Object(o.b)("inlineCode",{parentName:"p"},"watcher")," to run (using a scheduler)"))),Object(o.b)("p",null,"/src/core/observer/watcher.js"),Object(o.b)("pre",null,Object(o.b)("code",Object(a.a)({parentName:"pre"},{className:"language-js"}),"export default class Watcher {\n  ...\n  get() {\n    pushTarget(this) // Set Dep.target to this watcher object\n    ...\n    value = this.getter.call(vm, vm) // run the code\n    ...\n    popTarget() // remove current Dep.target\n    return value\n  }\n  update() {\n    if (this.lazy) {\n      this.dirty = true\n    } else if (this.sync) {\n      this.run() // shown below\n    } else {\n      queueWatcher(this) // queue this to run later\n    }\n  }\n  run() {\n    if (this.active) {\n      const value = this.get()\n    }\n  }\n  addDep(dep: Dep) { // This is called to start tracking a dep\n    ...\n    this.newDeps.push(dep) // The watcher also track's deps\n    dep.addSub(this) // Calls back to the dep (below)\n  }\n}\n")),Object(o.b)("p",null,"Now that you know what a ",Object(o.b)("inlineCode",{parentName:"p"},"Watcher")," looks like, the dep class should make a little more sense:"),Object(o.b)("p",null,"/src/core/observer/dep.js"),Object(o.b)("pre",null,Object(o.b)("code",Object(a.a)({parentName:"pre"},{className:"language-js"}),"export default class Dep {\n  ...\n  subs: Array<Watcher>;  // Notice our susbcribers are of class Watcher.\n  constructor () {\n    this.subs = []  // Our subscribers we need to keep track of\n  }\n  addSub(sub: Watcher) {  // You can think of this sub Watcher as our target\n    this.subs.push(sub)\n  }\n  ...\n  depend() { // <-- There's our depend function\n    if (Dep.target) {  // If target exists\n      Dep.target.addDep(this)  // Add this as a dependency, which ends up calling addSub function above.  Pushing this watcher.\n    }\n  }\n  notify() { // <--- There's our notify function\n    const subs = this.subs.slice()\n    for (let i = 0, l = subs.length; i < l; i++) {\n      subs[i].update()  // <-- Queue and run each subscriber\n    }\n  }\n}\n")),Object(o.b)("p",null,"Be sure to read through my code comments above. You can see how this is very similar to the reactivity engine we build in the previous level. If we look at our diagram again, it should make a little more sense:"),Object(o.b)("img",{alt:"reactivity4",src:Object(i.a)("/img/Reactivity4.png")}),Object(o.b)("p",null,"Some day you might need to dive into the source, and now perhaps it\u2019ll be a little less scary."),Object(o.b)("h2",{id:"problem-caveats-to-the-reactivity-system"},"Problem: Caveats to the Reactivity System"),Object(o.b)("p",null,"There are limitations to the reactivity system that you should get a little familiar with, and the Vue documentation is extremely well written on it. Some of these could cause some of those hair-pulling bugs someday, so trust me on taking a quick look."),Object(o.b)("p",null,"The first caveat involves ",Object(o.b)("a",Object(a.a)({parentName:"p"},{href:"https://vuejs.org/v2/guide/list.html#Array-Change-Detection"}),"addition or deletion of reactive properties"),", like inside the data object. The second involves ",Object(o.b)("a",Object(a.a)({parentName:"p"},{href:"https://vuejs.org/v2/guide/list.html#Array-Change-Detection"}),"the way you might make changes to an array that is reactive"),"."),Object(o.b)("h2",{id:"stay-tuned"},"Stay Tuned"),Object(o.b)("p",null,"Now that we have a good sense of how our Reactivity system works, in our next lesson we\u2019ll jump into our component rendering system. When you see how these two systems work together you\u2019ll have a deeper appreciation for the Component engine, and we\u2019ll begin to look at techniques to make our components more scalable."))}p.isMDXComponent=!0},156:function(e,t,n){"use strict";n.d(t,"a",(function(){return p})),n.d(t,"b",(function(){return h}));var a=n(0),r=n.n(a);function o(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function i(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function s(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?i(Object(n),!0).forEach((function(t){o(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):i(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function c(e,t){if(null==e)return{};var n,a,r=function(e,t){if(null==e)return{};var n,a,r={},o=Object.keys(e);for(a=0;a<o.length;a++)n=o[a],t.indexOf(n)>=0||(r[n]=e[n]);return r}(e,t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(a=0;a<o.length;a++)n=o[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(r[n]=e[n])}return r}var l=r.a.createContext({}),u=function(e){var t=r.a.useContext(l),n=t;return e&&(n="function"==typeof e?e(t):s({},t,{},e)),n},p=function(e){var t=u(e.components);return r.a.createElement(l.Provider,{value:t},e.children)},b={inlineCode:"code",wrapper:function(e){var t=e.children;return r.a.createElement(r.a.Fragment,{},t)}},d=Object(a.forwardRef)((function(e,t){var n=e.components,a=e.mdxType,o=e.originalType,i=e.parentName,l=c(e,["components","mdxType","originalType","parentName"]),p=u(n),d=a,h=p["".concat(i,".").concat(d)]||p[d]||b[d]||o;return n?r.a.createElement(h,s({ref:t},l,{components:n})):r.a.createElement(h,s({ref:t},l))}));function h(e,t){var n=arguments,a=t&&t.mdxType;if("string"==typeof e||a){var o=n.length,i=new Array(o);i[0]=d;var s={};for(var c in t)hasOwnProperty.call(t,c)&&(s[c]=t[c]);s.originalType=e,s.mdxType="string"==typeof e?e:a,i[1]=s;for(var l=2;l<o;l++)i[l]=n[l];return r.a.createElement.apply(null,i)}return r.a.createElement.apply(null,n)}d.displayName="MDXCreateElement"},157:function(e,t,n){"use strict";var a=n(0),r=n(35);t.a=function(){return Object(a.useContext)(r.a)}},158:function(e,t,n){"use strict";n.d(t,"a",(function(){return r}));var a=n(157);function r(e){const{siteConfig:t}=Object(a.a)(),{baseUrl:n="/"}=t||{};if(!e)return e;return/^(https?:|\/\/)/.test(e)?e:e.startsWith("/")?n+e.slice(1):n+e}}}]);