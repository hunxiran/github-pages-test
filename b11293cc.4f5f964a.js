(window.webpackJsonp=window.webpackJsonp||[]).push([[37],{136:function(e,t,n){"use strict";n.r(t),n.d(t,"frontMatter",(function(){return s})),n.d(t,"metadata",(function(){return c})),n.d(t,"rightToc",(function(){return p})),n.d(t,"default",(function(){return b}));var a=n(1),i=n(6),o=(n(0),n(156)),r=n(158),s={id:"lesson4",title:"Evan You on Vue Core",sidebar_label:"Lesson4"},c={id:"advanceComp/lesson4",title:"Evan You on Vue Core",description:"import useBaseUrl from '@docusaurus/useBaseUrl';\r",source:"@site/docs\\advanceComp\\lesson4.md",permalink:"/github-pages-test/docs/advanceComp/lesson4",editUrl:"https://github.com/facebook/docusaurus/edit/master/website/docs/advanceComp/lesson4.md",sidebar_label:"Lesson4",sidebar:"someSidebar",previous:{title:"Reactivity in Vuejs",permalink:"/github-pages-test/docs/advanceComp/lesson3"},next:{title:"Template Compilation",permalink:"/github-pages-test/docs/advanceComp/lesson5"}},p=[{value:"Constructor: the place where it all begins",id:"constructor-the-place-where-it-all-begins",children:[]},{value:"Little tweaks for performance",id:"little-tweaks-for-performance",children:[]},{value:"Question: Are proxies already used?",id:"question-are-proxies-already-used",children:[]},{value:"The sequence of code execution",id:"the-sequence-of-code-execution",children:[]},{value:"Where our data option is initialized and made reactive",id:"where-our-data-option-is-initialized-and-made-reactive",children:[]},{value:"The Observer class",id:"the-observer-class",children:[]},{value:"Why a separate Observer class?",id:"why-a-separate-observer-class",children:[]},{value:"Up Next",id:"up-next",children:[]}],l={rightToc:p};function b(e){var t=e.components,n=Object(i.a)(e,["components"]);return Object(o.b)("wrapper",Object(a.a)({},l,n,{components:t,mdxType:"MDXLayout"}),Object(o.b)("p",null,"In our last lesson we walked through the code base to find reactivity. I showed Evan the following diagram and asked him about any design choices he made along the way."),Object(o.b)("img",{alt:"vueCore1",src:Object(r.a)("/img/vueCore1.png")}),Object(o.b)("h2",{id:"constructor-the-place-where-it-all-begins"},"Constructor: the place where it all begins"),Object(o.b)("p",null,"When we create a new ",Object(o.b)("inlineCode",{parentName:"p"},"Vue")," instance using ",Object(o.b)("inlineCode",{parentName:"p"},"new Vue({\u2026})")," it calls the Vue ",Object(o.b)("inlineCode",{parentName:"p"},"constructor")," function. This function is pretty basic. It just calls the ",Object(o.b)("inlineCode",{parentName:"p"},"_init")," prototype method of Vue passing the ",Object(o.b)("inlineCode",{parentName:"p"},"options")," as the argument."),Object(o.b)("pre",null,Object(o.b)("code",Object(a.a)({parentName:"pre"},{className:"language-js"}),"//src/core/instance/index.js\nfunction Vue(options){ this._init(options) }\n")),Object(o.b)("h2",{id:"little-tweaks-for-performance"},"Little tweaks for performance"),Object(o.b)("p",null,"As Evan mentions refactors that were made to rule out some edge cases and improve performance. One such place is where a different strategy is used to merge all the options into ",Object(o.b)("inlineCode",{parentName:"p"},"vm.$options")," of an instance that is instantiating many components."),Object(o.b)("pre",null,Object(o.b)("code",Object(a.a)({parentName:"pre"},{className:"language-js"}),"//src/core/instance/init.js\n\nif (options && options._isComponent) {\n  // optimize internal component instantiation\n  // since dynamic options merging is pretty slow, and none of the\n  // internal component options needs special treatment.\n  initInternalComponent(vm, options)\n} else {\n  vm.$options = mergeOptions(\n    resolveConstructorOptions(vm.constructor),\n    options || {},\n    vm\n  )\n}\n")),Object(o.b)("p",null,"This is a common pattern we can observe in the code base where such optimization tweaks were made over time."),Object(o.b)("h2",{id:"question-are-proxies-already-used"},"Question: Are proxies already used?"),Object(o.b)("p",null,"This isn\u2019t a simple answer, Yes and No."),Object(o.b)("p",null,"-",Object(o.b)("strong",{parentName:"p"},"No:")," proxies are not used in the reactivity system yet.\n-",Object(o.b)("strong",{parentName:"p"},"Yes:")," proxies are used to improve developer experience for browsers that support them."),Object(o.b)("pre",null,Object(o.b)("code",Object(a.a)({parentName:"pre"},{className:"language-js"}),"//src/core/instance/init.js\nif (process.env.NODE_ENV !== 'production') {\n//used during development\n  initProxy(vm)\n} else {\n  vm._renderProxy = vm\n}\n")),Object(o.b)("p",null,"If a developer calls a method that doesn\u2019t exist in our component options, a proxy\u2019s ",Object(o.b)("a",Object(a.a)({parentName:"p"},{href:"https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Proxy/handler/has"}),"has()")," trap is used to catch the mistake and throw a warning. This looks like:"),Object(o.b)("img",{alt:"vueCore2",src:Object(r.a)("/img/vueCore2.png")}),Object(o.b)("h2",{id:"the-sequence-of-code-execution"},"The sequence of code execution"),Object(o.b)("p",null,"Evan shows us the sequence in which the Vue instance is set up and how each lifecycle hook is executed. He points out that understanding this code makes debugging easy."),Object(o.b)("pre",null,Object(o.b)("code",Object(a.a)({parentName:"pre"},{className:"language-js"}),"//src/core/instance/init.js\ninitLifecycle(vm)\ninitEvents(vm)\ninitRender(vm)\ncallHook(vm, 'beforeCreate')\ninitInjections(vm) // resolve injections before data/props\ninitState(vm)\ninitProvide(vm) // resolve provide after data/props\ncallHook(vm, 'created')\n")),Object(o.b)("ul",null,Object(o.b)("li",{parentName:"ul"},Object(o.b)("p",{parentName:"li"},Object(o.b)("inlineCode",{parentName:"p"},"initLifecycle(vm)"),": this sets up some initial properties like $parent, $refs etc on the vue instance.")),Object(o.b)("li",{parentName:"ul"},Object(o.b)("p",{parentName:"li"},Object(o.b)("inlineCode",{parentName:"p"},"initEvents(vm)"),": sets up methods related to custom events like ",Object(o.b)("inlineCode",{parentName:"p"},"vm.$emit"),", ",Object(o.b)("inlineCode",{parentName:"p"},"vm.$on"),", ",Object(o.b)("inlineCode",{parentName:"p"},"vm.$once")," etc.")),Object(o.b)("li",{parentName:"ul"},Object(o.b)("p",{parentName:"li"},Object(o.b)("inlineCode",{parentName:"p"},"initRender(vm)"),": sets up the ",Object(o.b)("inlineCode",{parentName:"p"},"render()")," and ",Object(o.b)("inlineCode",{parentName:"p"},"update()")," methods on the instance.")),Object(o.b)("li",{parentName:"ul"},Object(o.b)("p",{parentName:"li"},Object(o.b)("inlineCode",{parentName:"p"},"callHook(vm, 'beforeCreate')"),": the beforeCreate() lifecycle hook is called. Also, plugins like vuex add their properties to the instance in this hook.")),Object(o.b)("li",{parentName:"ul"},Object(o.b)("p",{parentName:"li"},Object(o.b)("inlineCode",{parentName:"p"},"initInjections(vm)"),": this is where all the ",Object(o.b)("a",Object(a.a)({parentName:"p"},{href:"https://vuejs.org/v2/guide/components-edge-cases.html#Dependency-Injection"}),"dependency-injections")," are set that are provided using the ",Object(o.b)("inlineCode",{parentName:"p"},"provide")," option by the parent.")),Object(o.b)("li",{parentName:"ul"},Object(o.b)("p",{parentName:"li"},Object(o.b)("inlineCode",{parentName:"p"},"initState(vm)"),": this is where all the props, methods, data, computed and watchers are initialized. You can see the sequence they are initialized below:"))),Object(o.b)("pre",null,Object(o.b)("code",Object(a.a)({parentName:"pre"},{className:"language-js"}),"//src/core/instance/state.js\nif (opts.props) initProps(vm, opts.props)\nif (opts.methods) initMethods(vm, opts.methods)\nif (opts.data) {\n  initData(vm)\n} else {\n  observe(vm._data = {}, true /* asRootData */)\n}\nif (opts.computed) initComputed(vm, opts.computed)\nif (opts.watch && opts.watch !== nativeWatch) {\n  initWatch(vm, opts.watch)\n}\n")),Object(o.b)("p",null,"The sequence of initialization explains why ",Object(o.b)("inlineCode",{parentName:"p"},"data")," properties can be accessed in ",Object(o.b)("inlineCode",{parentName:"p"},"computed")," properties and not vice-versa."),Object(o.b)("ul",null,Object(o.b)("li",{parentName:"ul"},Object(o.b)("p",{parentName:"li"},Object(o.b)("inlineCode",{parentName:"p"},"initProvide(vm)"),": the ",Object(o.b)("a",Object(a.a)({parentName:"p"},{href:"https://vuejs.org/v2/api/#provide-inject"}),"provide")," option is resolved")),Object(o.b)("li",{parentName:"ul"},Object(o.b)("p",{parentName:"li"},Object(o.b)("inlineCode",{parentName:"p"},"callHook(vm, 'created')"),": this is where the ",Object(o.b)("inlineCode",{parentName:"p"},"created()")," lifecycle hook is called. As you see from the sequence ",Object(o.b)("inlineCode",{parentName:"p"},"initState()")," is called before calling this hook. So all the ",Object(o.b)("inlineCode",{parentName:"p"},"data"),", ",Object(o.b)("inlineCode",{parentName:"p"},"props"),", ",Object(o.b)("inlineCode",{parentName:"p"},"methods")," and ",Object(o.b)("inlineCode",{parentName:"p"},"computed")," are already initialized. That\u2019s the reason we are able to use them in ",Object(o.b)("inlineCode",{parentName:"p"},"created()"),"."))),Object(o.b)("h2",{id:"where-our-data-option-is-initialized-and-made-reactive"},"Where our data option is initialized and made reactive"),Object(o.b)("pre",null,Object(o.b)("code",Object(a.a)({parentName:"pre"},{className:"language-js"}),"//src/core/instance/state.js\nexport function initState (vm: Component) {\n...\n  if (opts.data) {\n    initData(vm)\n  } else {\n    observe(vm._data = {}, true /* asRootData */)\n  }\n  ...\n}\n")),Object(o.b)("p",null,Object(o.b)("inlineCode",{parentName:"p"},"initData(vm)")," is where the ",Object(o.b)("inlineCode",{parentName:"p"},"data")," option is checked. If it is a function then the ",Object(o.b)("inlineCode",{parentName:"p"},"data")," option should return an object otherwise a warning will be displayed in the console."),Object(o.b)("p",null,"We now loop through the data properties and proxy them onto the instance. This means that we can access our data property named ",Object(o.b)("inlineCode",{parentName:"p"},"foo")," using ",Object(o.b)("inlineCode",{parentName:"p"},"this.foo")," instead of ",Object(o.b)("inlineCode",{parentName:"p"},"this.$data.foo"),". It also performs a check to not have conflicting names in our ",Object(o.b)("inlineCode",{parentName:"p"},"data"),", ",Object(o.b)("inlineCode",{parentName:"p"},"props")," and ",Object(o.b)("inlineCode",{parentName:"p"},"methods"),"."),Object(o.b)("pre",null,Object(o.b)("code",Object(a.a)({parentName:"pre"},{className:"language-js"}),"function initData (vm: Component) {\n  let data = vm.$options.data\n  // checks if data is function or object\n  ...\n  //proxies the data properties onto the instance\n  ...\n  \n  // observe data\n  observe(data, true /* asRootData */)\n}\n")),Object(o.b)("p",null,"Finally the ",Object(o.b)("inlineCode",{parentName:"p"},"observe(data,true)")," is called. This is where our normal data properties become reactive as we have discussed in the previous lessons."),Object(o.b)("h2",{id:"the-observer-class"},"The Observer class"),Object(o.b)("p",null,"The ",Object(o.b)("inlineCode",{parentName:"p"},"observe(data)")," function uses the ",Object(o.b)("inlineCode",{parentName:"p"},"Observer")," class. This Observer class is used to make code easier to organize and its main purpose is to convert the ",Object(o.b)("inlineCode",{parentName:"p"},"data")," properties into ",Object(o.b)("inlineCode",{parentName:"p"},"getters/setters"),". This is where ",Object(o.b)("inlineCode",{parentName:"p"},"dep.depend()")," and ",Object(o.b)("inlineCode",{parentName:"p"},"dep.notify"),"() are called as we have seen in the previous lessons."),Object(o.b)("p",null,"Evan elaborates on how the relationship between a particular dependency and its computation works. A computation is collected as a subscriber to that particular dependency of which it is a part of."),Object(o.b)("h2",{id:"why-a-separate-observer-class"},"Why a separate Observer class?"),Object(o.b)("p",null,"Evan clarifies that in the future this ",Object(o.b)("inlineCode",{parentName:"p"},"Observer")," class could be its own stand-alone package. This allows for the flexibility of creating a separate Observer class that uses proxies API. The two observers can be used in an interchangeable fashion so Vue can support both IE11 and evergreen browsers. This is projected for the Vue version 3.x as shown below:"),Object(o.b)("img",{alt:"vueCore3",src:Object(r.a)("/img/vueCore3.png")}),Object(o.b)("h2",{id:"up-next"},"Up Next"),Object(o.b)("p",null,"Now that we have a greater understanding of the Vue source & reactivity, we can begin our understanding of the Template Rendering process in the next lesson."))}b.isMDXComponent=!0},156:function(e,t,n){"use strict";n.d(t,"a",(function(){return b})),n.d(t,"b",(function(){return m}));var a=n(0),i=n.n(a);function o(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function r(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function s(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?r(Object(n),!0).forEach((function(t){o(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):r(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function c(e,t){if(null==e)return{};var n,a,i=function(e,t){if(null==e)return{};var n,a,i={},o=Object.keys(e);for(a=0;a<o.length;a++)n=o[a],t.indexOf(n)>=0||(i[n]=e[n]);return i}(e,t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(a=0;a<o.length;a++)n=o[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(i[n]=e[n])}return i}var p=i.a.createContext({}),l=function(e){var t=i.a.useContext(p),n=t;return e&&(n="function"==typeof e?e(t):s({},t,{},e)),n},b=function(e){var t=l(e.components);return i.a.createElement(p.Provider,{value:t},e.children)},d={inlineCode:"code",wrapper:function(e){var t=e.children;return i.a.createElement(i.a.Fragment,{},t)}},u=Object(a.forwardRef)((function(e,t){var n=e.components,a=e.mdxType,o=e.originalType,r=e.parentName,p=c(e,["components","mdxType","originalType","parentName"]),b=l(n),u=a,m=b["".concat(r,".").concat(u)]||b[u]||d[u]||o;return n?i.a.createElement(m,s({ref:t},p,{components:n})):i.a.createElement(m,s({ref:t},p))}));function m(e,t){var n=arguments,a=t&&t.mdxType;if("string"==typeof e||a){var o=n.length,r=new Array(o);r[0]=u;var s={};for(var c in t)hasOwnProperty.call(t,c)&&(s[c]=t[c]);s.originalType=e,s.mdxType="string"==typeof e?e:a,r[1]=s;for(var p=2;p<o;p++)r[p]=n[p];return i.a.createElement.apply(null,r)}return i.a.createElement.apply(null,n)}u.displayName="MDXCreateElement"},157:function(e,t,n){"use strict";var a=n(0),i=n(35);t.a=function(){return Object(a.useContext)(i.a)}},158:function(e,t,n){"use strict";n.d(t,"a",(function(){return i}));var a=n(157);function i(e){const{siteConfig:t}=Object(a.a)(),{baseUrl:n="/"}=t||{};if(!e)return e;return/^(https?:|\/\/)/.test(e)?e:e.startsWith("/")?n+e.slice(1):n+e}}}]);